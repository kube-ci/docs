> New to KubeCI engine? Please start [here](/docs/concepts/README.md).

# Credential Initializer

This tutorial will show you how to initialize docker and git credentials using service-account secrets. This credential-initializer step runs before any other steps and puts necessary configuration files for Docker and Git into shared `HOME` directory. For this, the service-account secrets should have annotations with prefix `credential.kube.ci/`.

Before we start, you need to have a Kubernetes cluster, and the kubectl command-line tool must be configured to communicate with your cluster. If you do not already have a cluster, you can create one by using [Minikube](https://github.com/kubernetes/minikube). Now, install KubeCI engine in your cluster following the steps [here](/docs/setup/install.md).

## Create Secrets

First, create secrets with docker and git credentials.

```console
$ kubectl apply -f ./docs/examples/credential-initializer/secret.yaml
secret/test-docker-basic created
secret/test-git-ssh created
```

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: test-docker-basic
  annotations:
    credential.kube.ci/docker-0: https://us.gcr.io
    credential.kube.ci/docker-1: https://eu.gcr.io
    credential.kube.ci/docker-2: https://asia.gcr.io
    credential.kube.ci/docker-3: https://gcr.io
    credential.kube.ci/docker-4: https://reduce-chance-of-selecting-gcr.io
type: kubernetes.io/basic-auth
data:
  # Generated by: echo -n _json_key | base64
  username: ...
  # Generated by: cat /tmp/key.json | base64 -w 0
  password: ...
---
apiVersion: v1
kind: Secret
metadata:
  name: test-git-ssh
  annotations:
    credential.kube.ci/git-0: github.com
type: kubernetes.io/ssh-auth
data:
  # Generated by: cat id_rsa | base64 -w 0
  ssh-privatekey: ...
  # Generated by: ssh-keyscan github.com | base64 -w 0
  known_hosts: ...
```

## Configure RBAC

You need to specify a service-account in `spec.serviceAccount` to ensure RBAC for the workflow. This service-account along with operator's service-account must have `list` and `watch` permissions for the resources specified in `spec.triggers`.

Create a service-account for the workflow and specify previously created secrets. Then, create a cluster-role with ConfigMap `list` and `watch` permissions. Now, bind it with service-accounts of both workflow and operator.

```console
$ kubectl apply -f ./docs/examples/credential-initializer/rbac.yaml
serviceaccount/wf-sa created
clusterrole.rbac.authorization.k8s.io/wf-role created
rolebinding.rbac.authorization.k8s.io/wf-role-binding created
clusterrolebinding.rbac.authorization.k8s.io/operator-role-binding created
```

## Create Workflow

```console
$ kubectl apply -f ./docs/examples/credential-initializer/workflow.yaml
workflow.engine.kube.ci/sample-workflow created
```

```yaml
apiVersion: engine.kube.ci/v1alpha1
kind: Workflow
metadata:
  name: sample-workflow
  namespace: default
spec:
  triggers:
  - apiVersion: v1
    kind: ConfigMap
    resource: configmaps
    namespace: default
    name: sample-config
    onCreateOrUpdate: true
    onDelete: false
  serviceAccount: wf-sa
  executionOrder: Serial
  allowManualTrigger: true
  steps:
  - name: step-ls-home
    image: alpine
    commands:
    - sh
    args:
    - -c
    - ls -laR $HOME
```

## Trigger Workflow

Now trigger the workflow by creating a `Trigger` custom-resource which contains a complete ConfigMap resource inside `.request` section.

```console
$ kubectl apply -f ./docs/examples/credential-initializer/trigger.yaml
trigger.extensions.kube.ci/sample-trigger created
```

Whenever a workflow is triggered, a workplan is created and respective pods are scheduled.

```console
$ kubectl get workplan -l workflow=sample-workflow
NAME                    CREATED AT
sample-workflow-xj9gl   13s
```

```console
$ kubectl get pods -l workplan=sample-workflow-xj9gl
NAME                      READY   STATUS      RESTARTS   AGE
sample-workflow-xj9gl-0   0/1     Completed   0          29s
```

## Check Logs

The `step-ls-home` prints the contents of `HOME` directory.

```console
$ kubectl get --raw '/apis/extensions.kube.ci/v1alpha1/namespaces/default/workplanlogs/sample-workflow-xj9gl?step=step-ls-home'
total 8
drwxr-xr-x    4 root     root           120 Oct 30 04:53 .
drwxr-xr-x    4 root     root          4096 Oct 30 04:53 ..
drwxr-xr-x    2 root     root            60 Oct 30 04:53 .docker
-rw-------    1 root     root             0 Oct 30 04:53 .git-credentials
-rw-------    1 root     root            29 Oct 30 04:53 .gitconfig
drwxr-xr-x    2 root     root           100 Oct 30 04:53 .ssh

/kubeci/home/.docker:
total 28
drwxr-xr-x    2 root     root            60 Oct 30 04:53 .
drwxr-xr-x    4 root     root           120 Oct 30 04:53 ..
-rw-------    1 root     root         28379 Oct 30 04:53 config.json

/kubeci/home/.ssh:
total 12
drwxr-xr-x    2 root     root           100 Oct 30 04:53 .
drwxr-xr-x    4 root     root           120 Oct 30 04:53 ..
-rw-------    1 root     root            91 Oct 30 04:53 config
-rw-------    1 root     root          3243 Oct 30 04:53 id_test-git-ssh
-rw-------    1 root     root           392 Oct 30 04:53 known_hosts
```

Here, we can see that, `HOME` directory is populated with docker and git configs. Since `HOME` directory is shared among all step-containers, all steps can access the same docker/git credentials.

## Cleanup

```console
$ kubectl delete -f docs/examples/credential-initializer/
serviceaccount "wf-sa" deleted
clusterrole.rbac.authorization.k8s.io "wf-role" deleted
rolebinding.rbac.authorization.k8s.io "wf-role-binding" deleted
clusterrolebinding.rbac.authorization.k8s.io "operator-role-binding" deleted
secret "test-docker-basic" deleted
secret "test-git-ssh" deleted
workflow.engine.kube.ci "sample-workflow" deleted
Error from server (NotFound): error when deleting "docs/examples/credential-initializer/trigger.yaml": the server could not find the requested resource
```

## Acknowledgement

This credential-initializer step is adopted from [knative/build](https://github.com/knative/docs/blob/master/build/auth.md).
